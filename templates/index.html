<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR-TS1 Bonepile Statistics Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }
        
        h1 {
            color: #212121;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        h2 {
            color: #424242;
            margin-top: 30px;
            border-left: 6px solid #1976d2;
            padding-left: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .metric-box {
            background: #ffffff;
            color: #212121;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        
        .metric-box:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.16);
            border-color: #bdbdbd;
        }
        
        .metric-box.success {
            border-left: 6px solid #2e7d32;
        }
        
        .metric-box.warning {
            border-left: 6px solid #f57c00;
        }
        
        .metric-box.info {
            border-left: 6px solid #1976d2;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: 600;
            margin: 10px 0;
            color: #212121;
        }
        
        .metric-label {
            font-size: 13px;
            color: #757575;
            font-weight: 500;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th {
            background: #424242;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .summary {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
        }
        
        .note-box {
            background: #fff3e0;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border-left: 6px solid #f57c00;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .chart-container {
            margin: 30px 0;
            position: relative;
            height: 400px;
        }
        
        .sn-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .sn-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            text-align: center;
            font-family: monospace;
        }
        
        #modal-body table {
            width: 100%;
        }
        
        #modal-body td {
            word-wrap: break-word;
            max-width: 300px;
            vertical-align: top;
        }
    </style>
    <!-- Shared theme (kept last to override page-specific legacy styles) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
</head>
<body>
    <div class="page-header">
        <div class="container">
            <div class="header-row">
                <div class="header-left">
                    <div>
                        <h1 style="margin: 0;">VR-TS1 Bonepile Dashboard</h1>
                        <div class="subtitle">IGS Test Results Analyzer ‚Ä¢ Real-time log insights</div>
                    </div>
                </div>
                <div class="nav-actions">
                    {% if show_daily_test_button %}
                    <a href="/daily-test-analysis" class="btn btn-secondary">Daily Test Analysis</a>
                    {% endif %}
                    <a href="/debug-comparison" class="btn btn-secondary">Debug Comparison</a>
                    <a href="/hourly-report" class="btn btn-secondary">Hourly Report</a>
                    <a href="/upload" class="btn btn-secondary">Upload</a>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <!-- legacy title removed; using shared page header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <p><strong>Generated:</strong> <span id="generated-time"></span></p>
                <p><strong>Source:</strong> NV_IGS_VR144_Bonepile.xlsx - Sheet VR-TS1</p>
                <p><strong>Server IP:</strong> <span style="font-family: monospace; background: #f0f0f0; padding: 2px 8px; border-radius: 3px;">{{ ip }}</span></p>
            </div>
        </div>
        
        {% if error %}
        <div class="note-box" style="background: #f8d7da; border-left-color: #dc3545;">
            <strong>‚ö†Ô∏è Error:</strong> {{ error }}<br>
            <a href="/upload" style="color: #721c24; font-weight: bold;">Click here to upload a file</a>
        </div>
        {% endif %}
        
        {% if stats %}
        <h2>1. TRAY SUMMARY</h2>
        <div class="metric-grid">
            <div class="metric-box" onclick="showSNList('total')" title="Total Trays: Count of unique Serial Numbers (SN) in format 183XXXXXXXX (13 digits). Each unique SN represents one tray in the Bonepile.">
                <div class="metric-label">Total Trays (Unique SN)</div>
                <div class="metric-value">{{ stats.total_trays }}</div>
                <div class="metric-label" style="font-size: 11px; margin-top: 5px;">Click to view list</div>
            </div>
            <div class="metric-box warning" onclick="showSNList('fail')" title="Fail Records: Total number of rows where Result column = 'FAIL'. This counts all fail records, including duplicates. The number in parentheses shows unique SN count.">
                <div class="metric-label">Fail Records</div>
                <div class="metric-value">{{ stats.total_fail }}</div>
                <div class="metric-label" style="font-size: 11px; margin-top: 5px;">({{ stats.total_fail_unique }} unique SN)</div>
                <div class="metric-label" style="font-size: 11px; margin-top: 5px;">Click to view list</div>
            </div>
            <div class="metric-box success" onclick="showSNList('pass')" title="Pass Records: Total number of rows where Result column = 'ALL PASS'. This counts all pass records, including duplicates. The number in parentheses shows unique SN count.">
                <div class="metric-label">Pass Records</div>
                <div class="metric-value">{{ stats.total_pass }}</div>
                <div class="metric-label" style="font-size: 11px; margin-top: 5px;">({{ stats.total_pass_unique }} unique SN)</div>
                <div class="metric-label" style="font-size: 11px; margin-top: 5px;">Click to view list</div>
            </div>
        </div>
        
        {% if stats %}
        <h2>2. TRAY STATISTICS</h2>
        <div class="chart-container">
            <canvas id="trayChart"></canvas>
        </div>
        
        <h2>3. WO STATISTICS</h2>
        <div class="chart-container">
            <canvas id="woChart"></canvas>
        </div>
        
        <h2>4. DISPOSITION STATISTICS</h2>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0;">
            <h3 style="margin-bottom: 15px;">Filters</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Start Date:</label>
                    <select id="filter-start-date" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">ALL</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">End Date:</label>
                    <select id="filter-end-date" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">ALL</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">WO:</label>
                    <select id="filter-wo" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">ALL</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="applyFilters()" style="background: #1976d2; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Apply Filters</button>
                <button onclick="showAllDispositions()" style="background: #424242; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">View All Dispositions (Debug)</button>
            </div>
        </div>
        
        <div id="disposition-stats-results" style="display: none;">
            <div class="metric-grid">
                <div class="metric-box info" onclick="showDispositionsByStatus('all')" style="cursor: pointer;" title="Total Dispositions: Total number of dispositions parsed from NV Disposition column (Column H). Each date format (MM/DD: description) counts as one disposition. Only rows with IGS Action (Column M) having a value are counted.">
                    <div class="metric-label">Total Dispositions</div>
                    <div class="metric-value" id="stat-total-dispositions">0</div>
                    <div class="metric-label" style="font-size: 11px; margin-top: 5px;">Click to view all</div>
                </div>
                <div class="metric-box success" onclick="showDispositionsByStatus('completed')" style="cursor: pointer;" title="Completed Dispositions: Dispositions are considered completed when: (1) Latest IGS Action date >= Latest NV Disposition date, OR (2) IGS Action is empty but IGS Status contains 'waiting for NV disposition' or Result is PASS/ALL PASS, OR (3) Only IGS Action date exists (no NV Disposition date).">
                    <div class="metric-label">Completed Dispositions</div>
                    <div class="metric-value" id="stat-completed-dispositions">0</div>
                    <div class="metric-label" style="font-size: 11px; margin-top: 5px;">Click to view details</div>
                </div>
                <div class="metric-box warning" onclick="showDispositionsByStatus('pending')" style="cursor: pointer;" title="Pending Dispositions: Dispositions that are not yet completed. This occurs when: Latest IGS Action date < Latest NV Disposition date AND Result is still 'FAIL', OR IGS Action is empty without completion indicators.">
                    <div class="metric-label">Pending Dispositions</div>
                    <div class="metric-value" id="stat-pending-dispositions">0</div>
                    <div class="metric-label" style="font-size: 11px; margin-top: 5px;">Click to view details</div>
                </div>
                <div class="metric-box info" title="Avg per Day: Average number of dispositions per day within the selected date range. Calculated as: Total Dispositions / Number of Days in the filtered period. If date filters are provided, uses the filter date range; otherwise uses min/max dates from dispositions.">
                    <div class="metric-label">Avg per Day</div>
                    <div class="metric-value" id="stat-avg-per-day">0</div>
                </div>
                <div class="metric-box info" title="Avg per Week: Average number of dispositions per week within the selected date range. Calculated as: Total Dispositions / Number of Weeks in the filtered period. Number of weeks = Number of Days / 7.">
                    <div class="metric-label">Avg per Week</div>
                    <div class="metric-value" id="stat-avg-per-week">0</div>
                </div>
            </div>
        </div>
        
        <h2>3. CURRENT DISPOSITIONS</h2>
        <div id="current-dispositions-results" style="display: none;">
            <div class="metric-grid">
                <div class="metric-box success" onclick="showCurrentDispositions('completed')" style="cursor: pointer;" title="Current Dispositions - Completed: Rows where Result = 'FAIL' and PIC = 'IGS', and IGS Status does NOT contain 'testing' or 'waiting' (except 'waiting for disposition'). These represent dispositions that are currently being processed and are completed.">
                    <div class="metric-label">Completed</div>
                    <div class="metric-value" id="current-completed">0</div>
                    <div class="metric-label" style="font-size: 11px; margin-top: 5px;">Click to view details</div>
                </div>
                <div class="metric-box warning" onclick="showCurrentDispositions('waiting')" style="cursor: pointer;" title="Current Dispositions - Waiting: Rows where Result = 'FAIL' and PIC = 'IGS', and IGS Status contains 'testing' or 'waiting' (but NOT 'waiting for disposition'). These are dispositions waiting for action.">
                    <div class="metric-label">Waiting</div>
                    <div class="metric-value" id="current-waiting">0</div>
                    <div class="metric-label" style="font-size: 11px; margin-top: 5px;">Click to view details</div>
                </div>
                <div class="metric-box warning" onclick="showCurrentDispositions('waiting_material')" style="cursor: pointer;" title="Current Dispositions - Waiting for Material: Rows where Result = 'FAIL' and PIC = 'IGS', and IGS Status contains 'waiting for material', 'waiting for strata', or 'waiting for cx9'. These dispositions are waiting for material/components.">
                    <div class="metric-label">Waiting for Material</div>
                    <div class="metric-value" id="current-waiting-material">0</div>
                    <div class="metric-label" style="font-size: 11px; margin-top: 5px;">Click to view details</div>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if stats %}
        <h2>6. IN-PROCESS DISPOSITIONS</h2>
        <div class="metric-grid">
            <div class="metric-box info" onclick="showInProcess()" title="In Process Dispositions: Rows where IGS Status contains 'waiting', 'testing', 'in process', or 'in progress'. These are dispositions that are currently being processed or tested. The number in parentheses shows unique SN count.">
                <div class="metric-label">In Process Dispositions</div>
                <div class="metric-value">{{ stats.in_process }}</div>
                <div class="metric-label" style="font-size: 11px; margin-top: 5px;">({{ stats.in_process_unique }} unique SN)</div>
                <div class="metric-label" style="font-size: 11px; margin-top: 5px;">Click to view details</div>
            </div>
        </div>
        
        <h2>7. AVERAGE DURATION</h2>
        <div class="summary">
            <table>
                <tr><th>Metric</th><th>Value</th></tr>
                <tr><td>Records with BP Duration (from completed dispositions)</td><td>{{ stats.duration_count }}</td></tr>
                <tr><td>Average</td><td>{{ "%.2f"|format(stats.avg_duration) }} days</td></tr>
                <tr><td>Median</td><td>{{ "%.2f"|format(stats.median_duration) }} days</td></tr>
                <tr><td>Min</td><td>{{ "%.2f"|format(stats.min_duration) }} days</td></tr>
                <tr><td>Max</td><td>{{ "%.2f"|format(stats.max_duration) }} days</td></tr>
                <tr><td>Standard Deviation</td><td>{{ "%.2f"|format(stats.std_duration) }} days</td></tr>
            </table>
        </div>
        {% endif %}
        {% endif %}
        
        <h2>8. FIELD DESCRIPTIONS</h2>
        <div class="summary" style="margin-top: 30px;">
            <h3 style="margin-bottom: 15px; color: #2c3e50;">Metric Definitions</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <tr style="background: #3498db; color: white;">
                    <th style="padding: 12px; text-align: left; width: 200px;">Field</th>
                    <th style="padding: 12px; text-align: left;">Description</th>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Total Trays</td>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd;">Count of unique Serial Numbers (SN) in format 183XXXXXXXX (13 digits). Each unique SN represents one tray in the Bonepile.</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Fail Records</td>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd;">Total number of rows where Result column = "FAIL". This counts all fail records, including duplicates. The number in parentheses shows unique SN count.</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Pass Records</td>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd;">Total number of rows where Result column = "ALL PASS". This counts all pass records, including duplicates. The number in parentheses shows unique SN count.</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Total Dispositions</td>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd;">Total number of dispositions parsed from NV Disposition column (Column H). Each date format (MM/DD: description) counts as one disposition. Only rows with IGS Action (Column M) having a value are counted.</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Completed Dispositions</td>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd;">Dispositions are considered completed when: (1) Latest IGS Action date >= Latest NV Disposition date, OR (2) IGS Action is empty but IGS Status contains "waiting for NV disposition" or Result is PASS/ALL PASS, OR (3) Only IGS Action date exists (no NV Disposition date).</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Pending Dispositions</td>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd;">Dispositions that are not yet completed. This occurs when: Latest IGS Action date < Latest NV Disposition date AND Result is still "FAIL", OR IGS Action is empty without completion indicators.</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Current Dispositions - Completed</td>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd;">Rows where Result = "FAIL" and PIC = "IGS", and IGS Status does NOT contain "testing" or "waiting" (except "waiting for disposition"). These represent dispositions that are currently being processed and are completed.</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Current Dispositions - Waiting</td>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd;">Rows where Result = "FAIL" and PIC = "IGS", and IGS Status contains "testing" or "waiting" (but NOT "waiting for disposition"). These are dispositions waiting for action.</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Current Dispositions - Waiting for Material</td>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd;">Rows where Result = "FAIL" and PIC = "IGS", and IGS Status contains "waiting for material", "waiting for strata", or "waiting for cx9". These dispositions are waiting for material/components.</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">WO Statistics</td>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd;">Statistics grouped by Work Order (WO). WO is mapped from FA_Work_Log.xlsx file. Shows tray pass/fail counts and disposition statistics for each WO. Chart updates based on date range and WO filters.</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Avg per Day</td>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd;">Average number of dispositions per day within the selected date range. Calculated as: Total Dispositions / Number of Days in the filtered period. If date filters are provided, uses the filter date range; otherwise uses min/max dates from dispositions.</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Avg per Week</td>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd;">Average number of dispositions per week within the selected date range. Calculated as: Total Dispositions / Number of Weeks in the filtered period. Number of weeks = Number of Days / 7.</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">In Process Dispositions</td>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd;">Rows where IGS Status contains "waiting", "testing", "in process", or "in progress". These are dispositions that are currently being processed or tested. The number in parentheses shows unique SN count.</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Waiting for Material</td>
                    <td style="padding: 10px; border-bottom: 1px solid #ddd;">Rows where IGS Status contains "waiting for material", "waiting for strata", or "waiting for cx9". These dispositions are waiting for material or components to proceed. The number in parentheses shows unique SN count.</td>
                </tr>
            </table>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <script>
        // Set generated time
        document.addEventListener('DOMContentLoaded', function() {
            const generatedTimeEl = document.getElementById('generated-time');
            if (generatedTimeEl) {
                generatedTimeEl.textContent = new Date().toLocaleString();
            }
        });
        
        // Modal functions - always available
        const modal = document.getElementById('modal');
        const closeBtn = document.querySelector('.close');
        
        if (closeBtn) {
            closeBtn.onclick = function() {
                if (modal) modal.style.display = 'none';
            }
        }
        
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        // Cache management functions
        function getCacheKey(category, type) {
            return `sn_cache_${category}_${type || 'default'}`;
        }
        
        function saveToCache(key, data) {
            try {
                const cacheData = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(key, JSON.stringify(cacheData));
            } catch (e) {
                console.warn('Failed to save to cache:', e);
            }
        }
        
        function loadFromCache(key, maxAge = 300000) { // Default 5 minutes
            try {
                const cached = localStorage.getItem(key);
                if (!cached) return null;
                
                const cacheData = JSON.parse(cached);
                const age = Date.now() - cacheData.timestamp;
                
                if (age > maxAge) {
                    localStorage.removeItem(key);
                    return null;
                }
                
                return cacheData.data;
            } catch (e) {
                console.warn('Failed to load from cache:', e);
                return null;
            }
        }
        
        function showSNList(category) {
            const cacheKey = getCacheKey('sn-list', category);
            const modalBody = document.getElementById('modal-body');
            
            if (!modalBody || !modal) return;
            
            // Try to load from cache first
            const cachedData = loadFromCache(cacheKey, 600000); // 10 minutes cache
            if (cachedData) {
                // Show cached data immediately
                modalBody.innerHTML = `<h2>${category.toUpperCase()} Trays (${cachedData.count} total)</h2>
                    <div style="margin-bottom: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 12px; color: #1976d2;">
                        üì¶ Showing: <strong>SN Count</strong> - Unique Serial Numbers (trays). Data loaded from cache.
                    </div>
                    <div class="sn-list">${cachedData.sns.map(sn => `<div class="sn-item">${sn}</div>`).join('')}</div>`;
                modal.style.display = 'block';
            } else {
                // Show loading
                modalBody.innerHTML = '<div class="loading">Loading SN list...</div>';
                modal.style.display = 'block';
            }
            
            // Fetch fresh data and update
            fetch(`/api/sn-list/${category}`)
                .then(response => response.json())
                .then(data => {
                    // Save to cache
                    saveToCache(cacheKey, data);
                    
                    // Update modal with fresh data
                    modalBody.innerHTML = `<h2>${category.toUpperCase()} Trays (${data.count} total)</h2>
                        <div style="margin-bottom: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 12px; color: #1976d2;">
                            üì¶ Showing: <strong>SN Count</strong> - Unique Serial Numbers (trays). Each SN = 1 tray.
                        </div>
                        <div class="sn-list">${data.sns.map(sn => `<div class="sn-item">${sn}</div>`).join('')}</div>`;
                })
                .catch(error => {
                    console.error('Error fetching SN list:', error);
                    if (!cachedData) {
                        modalBody.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
                    }
                });
        }
        
        function showFailEmptyAction() {
            fetch('/api/fail-empty-action')
                .then(response => response.json())
                .then(data => {
                    const modalBody = document.getElementById('modal-body');
                    if (modalBody && modal) {
                        modalBody.innerHTML = `<h2>SN Fail with Empty IGS Action (${data.count} total)</h2>
                            <table>
                                <tr><th>SN</th><th>NV Disposition</th></tr>
                                ${data.data.map(item => `
                                    <tr>
                                        <td>${item.sn}</td>
                                        <td>${item.nv_disposition}</td>
                                    </tr>
                                `).join('')}
                            </table>`;
                        modal.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error fetching fail empty action:', error);
                    alert('Error loading data. Please try again.');
                });
        }
        
        function showInProcess() {
            const cacheKey = getCacheKey('in-process', 'default');
            const modalBody = document.getElementById('modal-body');
            
            if (!modalBody || !modal) return;
            
            // Try to load from cache first
            const cachedData = loadFromCache(cacheKey, 600000);
            if (cachedData) {
                modalBody.innerHTML = `<h2>In Process Dispositions (${cachedData.count} total)</h2>
                    <div style="margin-bottom: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 12px; color: #1976d2;">
                        üìä Showing: <strong>Test Count</strong> - Total test entries. Data loaded from cache.
                    </div>
                    <table>
                        <tr><th>SN</th><th>NV Disposition</th><th>IGS Action</th><th>IGS Status</th></tr>
                        ${cachedData.data.map(item => `
                            <tr>
                                <td><strong>${item.sn}</strong></td>
                                <td>${item.nv_disposition || 'N/A'}</td>
                                <td>${item.igs_action || 'N/A'}</td>
                                <td>${item.igs_status || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </table>`;
                modal.style.display = 'block';
            } else {
                modalBody.innerHTML = '<div class="loading">Loading in-process dispositions...</div>';
                modal.style.display = 'block';
            }
            
            // Fetch fresh data
            fetch('/api/in-process')
                .then(response => response.json())
                .then(data => {
                    saveToCache(cacheKey, data);
                    
                    modalBody.innerHTML = `<h2>In Process Dispositions (${data.count} total)</h2>
                        <div style="margin-bottom: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 12px; color: #1976d2;">
                            üìä Showing: <strong>Test Count</strong> - Total test entries where IGS Status contains 'waiting', 'testing', 'in process', or 'in progress'.
                        </div>
                        <table>
                            <tr><th>SN</th><th>NV Disposition</th><th>IGS Action</th><th>IGS Status</th></tr>
                            ${data.data.map(item => `
                                <tr>
                                    <td><strong>${item.sn}</strong></td>
                                    <td>${item.nv_disposition || 'N/A'}</td>
                                    <td>${item.igs_action || 'N/A'}</td>
                                    <td>${item.igs_status || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </table>`;
                })
                .catch(error => {
                    console.error('Error fetching in-process:', error);
                    if (!cachedData) {
                        modalBody.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
                    }
                });
        }
        
        
        {% if stats %}
        // Charts - only initialize if stats exist
        document.addEventListener('DOMContentLoaded', function() {
            const trayChartEl = document.getElementById('trayChart');
            if (trayChartEl) {
                const trayCtx = trayChartEl.getContext('2d');
                const totalTrays = {{ stats.total_pass }} + {{ stats.total_fail }};
                const passPercent = totalTrays > 0 ? (({{ stats.total_pass }} / totalTrays) * 100).toFixed(1) : 0;
                const failPercent = totalTrays > 0 ? (({{ stats.total_fail }} / totalTrays) * 100).toFixed(1) : 0;
                
                new Chart(trayCtx, {
                    type: 'pie',
                    data: {
                        labels: [`Pass (${passPercent}%)`, `Fail (${failPercent}%)`],
                        datasets: [{
                            data: [{{ stats.total_pass }}, {{ stats.total_fail }}],
                            backgroundColor: ['#38ef7d', '#f5576c'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Tray Distribution (Pass vs Fail)'
                            },
                            legend: {
                                display: true,
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Load initial charts and stats
            loadWOChart();
            loadDispositionStats();
            loadCurrentDispositions();
        });
        {% endif %}
        
        // Global variable to store WO chart instance
        let woChartInstance = null;
        
        function loadWOChart() {
            const woChartEl = document.getElementById('woChart');
            if (!woChartEl) return;
            
            // Get current filter values
            const startDate = document.getElementById('filter-start-date')?.value || '';
            const endDate = document.getElementById('filter-end-date')?.value || '';
            const wo = document.getElementById('filter-wo')?.value || '';
            
            let url = '/api/wo-statistics?';
            if (startDate) url += `start_date=${startDate}&`;
            if (endDate) url += `end_date=${endDate}&`;
            if (wo) url += `wo=${wo}&`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }
                    
                    // Destroy existing chart if it exists
                    if (woChartInstance) {
                        woChartInstance.destroy();
                    }
                    
                    const woLabels = data.data.map(item => item.wo || 'No WO');
                    const passData = data.data.map(item => item.tray_pass);
                    const failData = data.data.map(item => item.tray_fail);
                    const dispData = data.data.map(item => item.dispositions);
                    const dispCompletedData = data.data.map(item => item.dispositions_completed);
                    
                    const woCtx = woChartEl.getContext('2d');
                    woChartInstance = new Chart(woCtx, {
                        type: 'bar',
                        data: {
                            labels: woLabels,
                            datasets: [
                                {
                                    label: 'Tray Pass',
                                    data: passData,
                                    backgroundColor: '#38ef7d',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Tray Fail',
                                    data: failData,
                                    backgroundColor: '#f5576c',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Dispositions',
                                    data: dispData,
                                    backgroundColor: '#4facfe',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Dispositions Completed',
                                    data: dispCompletedData,
                                    backgroundColor: '#11998e',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Statistics by Work Order (WO)'
                                },
                                legend: {
                                    display: true,
                                    position: 'top'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    stacked: false
                                },
                                x: {
                                    stacked: false
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading WO statistics:', error);
                });
        }
        
        function applyFilters() {
            loadDispositionStats();
            loadWOChart();
        }
        
        function loadDispositionStats() {
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            const wo = document.getElementById('filter-wo').value;
            
            let url = '/api/disposition-stats?';
            if (startDate) url += `start_date=${startDate}&`;
            if (endDate) url += `end_date=${endDate}&`;
            if (wo) url += `wo=${wo}&`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }
                    
                    // Update dropdowns
                    const startDateSelect = document.getElementById('filter-start-date');
                    const endDateSelect = document.getElementById('filter-end-date');
                    const woSelect = document.getElementById('filter-wo');
                    
                    // Populate date dropdowns
                    if (data.unique_dates) {
                        data.unique_dates.forEach(date => {
                            if (!startDateSelect.querySelector(`option[value="${date}"]`)) {
                                const option = document.createElement('option');
                                option.value = date;
                                option.textContent = date;
                                startDateSelect.appendChild(option);
                            }
                            if (!endDateSelect.querySelector(`option[value="${date}"]`)) {
                                const option = document.createElement('option');
                                option.value = date;
                                option.textContent = date;
                                endDateSelect.appendChild(option);
                            }
                        });
                    }
                    
                    // Populate WO dropdown
                    if (data.unique_wos) {
                        data.unique_wos.forEach(wo_val => {
                            if (wo_val && !woSelect.querySelector(`option[value="${wo_val}"]`)) {
                                const option = document.createElement('option');
                                option.value = wo_val;
                                option.textContent = wo_val;
                                woSelect.appendChild(option);
                            }
                        });
                    }
                    
                    // Update stats display
                    document.getElementById('stat-total-dispositions').textContent = data.total_dispositions || 0;
                    document.getElementById('stat-completed-dispositions').textContent = data.completed_dispositions || 0;
                    document.getElementById('stat-pending-dispositions').textContent = data.pending_dispositions || 0;
                    document.getElementById('stat-avg-per-day').textContent = data.avg_per_day || 0;
                    document.getElementById('stat-avg-per-week').textContent = data.avg_per_week || 0;
                    document.getElementById('disposition-stats-results').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading disposition stats:', error);
                });
        }
        
        function loadCurrentDispositions() {
            fetch('/api/current-dispositions')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }
                    
                    document.getElementById('current-completed').textContent = data.total_completed || 0;
                    document.getElementById('current-waiting').textContent = data.total_waiting || 0;
                    document.getElementById('current-waiting-material').textContent = data.total_waiting_material || 0;
                    document.getElementById('current-dispositions-results').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading current dispositions:', error);
                });
        }
        
        function showAllDispositions() {
            fetch('/api/all-dispositions')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }
                    
                    const modalBody = document.getElementById('modal-body');
                    if (modalBody && modal) {
                        let html = `<h2>All Dispositions (Debug View)</h2>`;
                        html += `<p><strong>Total:</strong> ${data.total} | <strong>Completed:</strong> ${data.completed} | <strong>Pending:</strong> ${data.pending}</p>`;
                        html += `<div style="max-height: 70vh; overflow-y: auto;">`;
                        html += `<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">`;
                        html += `<tr style="background: #3498db; color: white; position: sticky; top: 0;">`;
                        html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Date</th>`;
                        html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">SN</th>`;
                        html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">WO</th>`;
                        html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Description</th>`;
                        html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Status</th>`;
                        html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Row IDX</th>`;
                        html += `</tr>`;
                        
                        data.data.forEach(disp => {
                            const statusColor = disp.is_completed ? '#38ef7d' : '#f5576c';
                            const statusText = disp.is_completed ? 'Completed' : 'Pending';
                            html += `<tr>`;
                            html += `<td style="padding: 8px; border: 1px solid #ddd;">${disp.date || 'N/A'}</td>`;
                            html += `<td style="padding: 8px; border: 1px solid #ddd; font-family: monospace;">${disp.sn}</td>`;
                            html += `<td style="padding: 8px; border: 1px solid #ddd; font-family: monospace;">${disp.wo || 'N/A'}</td>`;
                            html += `<td style="padding: 8px; border: 1px solid #ddd; max-width: 400px; word-wrap: break-word;">${disp.description || 'N/A'}</td>`;
                            html += `<td style="padding: 8px; border: 1px solid #ddd; color: ${statusColor}; font-weight: bold;">${statusText}</td>`;
                            html += `<td style="padding: 8px; border: 1px solid #ddd;">${disp.row_idx}</td>`;
                            html += `</tr>`;
                        });
                        
                        html += `</table>`;
                        html += `</div>`;
                        modalBody.innerHTML = html;
                        modal.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error loading all dispositions:', error);
                    alert('Error loading dispositions. Please check console for details.');
                });
        }
        
        function showDispositionsByStatus(status) {
            // Get current filter values
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            const wo = document.getElementById('filter-wo').value;
            
            fetch('/api/all-dispositions')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }
                    
                    // Filter by status
                    let filteredData = data.data;
                    if (status === 'completed') {
                        filteredData = data.data.filter(d => d.is_completed);
                    } else if (status === 'pending') {
                        filteredData = data.data.filter(d => !d.is_completed);
                    }
                    
                    // Apply date and WO filters
                    if (startDate) {
                        filteredData = filteredData.filter(d => d.date >= startDate);
                    }
                    if (endDate) {
                        filteredData = filteredData.filter(d => d.date <= endDate);
                    }
                    if (wo && wo !== 'ALL') {
                        filteredData = filteredData.filter(d => d.wo === wo);
                    }
                    
                    const modalBody = document.getElementById('modal-body');
                    if (modalBody && modal) {
                        const statusTitle = status === 'all' ? 'All' : (status === 'completed' ? 'Completed' : 'Pending');
                        let html = `<h2>${statusTitle} Dispositions (${filteredData.length} total)</h2>`;
                        html += `<div style="max-height: 70vh; overflow-y: auto;">`;
                        html += `<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">`;
                        html += `<tr style="background: #3498db; color: white; position: sticky; top: 0;">`;
                        html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Date</th>`;
                        html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">SN</th>`;
                        html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">WO</th>`;
                        html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Description</th>`;
                        html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Status</th>`;
                        html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Row IDX</th>`;
                        html += `</tr>`;
                        
                        filteredData.forEach(disp => {
                            const statusColor = disp.is_completed ? '#38ef7d' : '#f5576c';
                            const statusText = disp.is_completed ? 'Completed' : 'Pending';
                            html += `<tr>`;
                            html += `<td style="padding: 8px; border: 1px solid #ddd;">${disp.date || 'N/A'}</td>`;
                            html += `<td style="padding: 8px; border: 1px solid #ddd; font-family: monospace;">${disp.sn}</td>`;
                            html += `<td style="padding: 8px; border: 1px solid #ddd; font-family: monospace;">${disp.wo || 'N/A'}</td>`;
                            html += `<td style="padding: 8px; border: 1px solid #ddd; max-width: 400px; word-wrap: break-word;">${disp.description || 'N/A'}</td>`;
                            html += `<td style="padding: 8px; border: 1px solid #ddd; color: ${statusColor}; font-weight: bold;">${statusText}</td>`;
                            html += `<td style="padding: 8px; border: 1px solid #ddd;">${disp.row_idx}</td>`;
                            html += `</tr>`;
                        });
                        
                        html += `</table>`;
                        html += `</div>`;
                        modalBody.innerHTML = html;
                        modal.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error loading dispositions:', error);
                    alert('Error loading dispositions. Please check console for details.');
                });
        }
        
        function showCurrentDispositions(type) {
            const cacheKey = getCacheKey('current-dispositions', type);
            const modalBody = document.getElementById('modal-body');
            
            if (!modalBody || !modal) return;
            
            // Try to load from cache first
            const cachedData = loadFromCache(cacheKey, 600000);
            let dispositions = [];
            let title = '';
            
            if (cachedData) {
                if (type === 'completed') {
                    dispositions = cachedData.completed || [];
                    title = 'Completed Current Dispositions';
                } else if (type === 'waiting') {
                    dispositions = cachedData.waiting || [];
                    title = 'Waiting Current Dispositions';
                } else if (type === 'waiting_material') {
                    dispositions = cachedData.waiting_material || [];
                    title = 'Waiting for Material Current Dispositions';
                }
                
                // Show cached data immediately
                let html = `<h2>${title} (${dispositions.length} total)</h2>`;
                html += `<div style="margin-bottom: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 12px; color: #1976d2;">
                    üì¶ Showing: <strong>SN Count</strong> - Unique Serial Numbers. Data loaded from cache.
                </div>`;
                html += `<div style="max-height: 70vh; overflow-y: auto;">`;
                html += `<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">`;
                html += `<tr style="background: #3498db; color: white; position: sticky; top: 0;">`;
                html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">SN</th>`;
                html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">WO</th>`;
                html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">IGS Status</th>`;
                html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Row IDX</th>`;
                html += `</tr>`;
                
                dispositions.forEach(disp => {
                    html += `<tr>`;
                    html += `<td style="padding: 8px; border: 1px solid #ddd; font-family: monospace;"><strong>${disp.sn}</strong></td>`;
                    html += `<td style="padding: 8px; border: 1px solid #ddd; font-family: monospace;">${disp.wo || 'N/A'}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid #ddd; max-width: 400px; word-wrap: break-word;">${disp.igs_status || 'N/A'}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid #ddd;">${disp.row_idx}</td>`;
                    html += `</tr>`;
                });
                
                html += `</table></div>`;
                modalBody.innerHTML = html;
                modal.style.display = 'block';
            } else {
                modalBody.innerHTML = '<div class="loading">Loading current dispositions...</div>';
                modal.style.display = 'block';
            }
            
            // Fetch fresh data
            fetch('/api/current-dispositions')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        if (!cachedData) {
                            modalBody.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                        }
                        return;
                    }
                    
                    // Save to cache
                    saveToCache(cacheKey, data);
                    
                    if (type === 'completed') {
                        dispositions = data.completed || [];
                        title = 'Completed Current Dispositions';
                    } else if (type === 'waiting') {
                        dispositions = data.waiting || [];
                        title = 'Waiting Current Dispositions';
                    } else if (type === 'waiting_material') {
                        dispositions = data.waiting_material || [];
                        title = 'Waiting for Material Current Dispositions';
                    }
                    
                    let html = `<h2>${title} (${dispositions.length} total)</h2>`;
                    html += `<div style="margin-bottom: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 12px; color: #1976d2;">
                        üì¶ Showing: <strong>SN Count</strong> - Unique Serial Numbers where Result = 'FAIL' and PIC = 'IGS'.
                    </div>`;
                    html += `<div style="max-height: 70vh; overflow-y: auto;">`;
                    html += `<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">`;
                    html += `<tr style="background: #3498db; color: white; position: sticky; top: 0;">`;
                    html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">SN</th>`;
                    html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">WO</th>`;
                    html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">IGS Status</th>`;
                    html += `<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Row IDX</th>`;
                    html += `</tr>`;
                    
                    dispositions.forEach(disp => {
                        html += `<tr>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; font-family: monospace;"><strong>${disp.sn}</strong></td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; font-family: monospace;">${disp.wo || 'N/A'}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; max-width: 400px; word-wrap: break-word;">${disp.igs_status || 'N/A'}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${disp.row_idx}</td>`;
                        html += `</tr>`;
                    });
                    
                    html += `</table></div>`;
                    modalBody.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading current dispositions:', error);
                    if (!cachedData) {
                        modalBody.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
                    }
                });
        }
    </script>
</body>
</html>

