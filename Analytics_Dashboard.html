<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
  body {
    box-sizing: border-box;
  }
  
  :root {
    --color-primary: #6366F1;
    --color-surface: #FFFFFF;
    --color-text: #1E293B;
    --color-bg: #F1F5F9;
    --color-accent: #10B981;
    --color-border: #E2E8F0;
    --color-muted: #64748B;
    --color-hover: #F8FAFC;
  }
  .dark {
    --color-primary: #818CF8;
    --color-surface: #1E293B;
    --color-text: #F1F5F9;
    --color-bg: #0F172A;
    --color-accent: #34D399;
    --color-border: #334155;
    --color-muted: #94A3B8;
    --color-hover: #334155;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--color-bg);
    color: var(--color-text);
    transition: background-color 0.3s, color 0.3s;
    font-size: 15px;
    line-height: 1.6;
  }
  .app-wrapper {
    min-height: 100%;
    width: 100%;
    overflow-auto;
  }
  header {
    background: var(--color-surface);
    border-bottom: 2px solid var(--color-border);
    padding: 1.25rem 1.5rem;
    position: sticky;
    top: 0;
    z-index: 50;
    backdrop-filter: blur(8px);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }
  .header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  h1 {
    font-size: 1.75rem;
    font-weight: 800;
    color: var(--color-text);
    letter-spacing: -0.025em;
  }
  .header-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .icon-btn {
    width: 42px;
    height: 42px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg);
    border: 1.5px solid var(--color-border);
    color: var(--color-muted);
    cursor: pointer;
    transition: all 0.2s;
  }
  .icon-btn:hover {
    background: var(--color-hover);
    border-color: var(--color-primary);
    color: var(--color-primary);
    transform: translateY(-1px);
  }
  .btn-primary {
    background: var(--color-primary);
    color: white;
    padding: 0.625rem 1.25rem;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25);
  }
  .btn-primary:hover {
    background: #4F46E5;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
  }
  .btn-ghost {
    background: transparent;
    color: var(--color-muted);
    padding: 0.625rem 1.25rem;
    border-radius: 10px;
    border: 1.5px solid var(--color-border);
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-ghost:hover {
    background: var(--color-hover);
    border-color: var(--color-primary);
    color: var(--color-primary);
  }
  main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }
  .panel {
    background: var(--color-surface);
    border-radius: 16px;
    padding: 1.75rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border: 1.5px solid var(--color-border);
    transition: all 0.3s;
  }
  .panel:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }
  h2 {
    font-size: 1.625rem;
    font-weight: 800;
    color: var(--color-text);
    letter-spacing: -0.025em;
  }
  h3 {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--color-text);
  }
  .input-field {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1.5px solid var(--color-border);
    border-radius: 10px;
    background: var(--color-bg);
    color: var(--color-text);
    font-size: 0.9375rem;
    font-weight: 500;
    transition: all 0.2s;
    font-family: inherit;
  }
  .input-field:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }
  .toggle-group {
    display: flex;
    background: var(--color-bg);
    border-radius: 10px;
    padding: 0.375rem;
    gap: 0.375rem;
    border: 1.5px solid var(--color-border);
  }
  .toggle-btn {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    background: transparent;
    border: none;
    color: var(--color-muted);
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .toggle-btn.active {
    background: var(--color-surface);
    color: var(--color-primary);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
  }
  .data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.9375rem;
  }
  .data-table thead th {
    background: var(--color-bg);
    padding: 1rem 1.25rem;
    text-align: left;
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--color-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 2px solid var(--color-border);
    position: sticky;
    top: 0;
  }
  .data-table tbody td {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--color-border);
    color: var(--color-text);
    font-weight: 500;
  }
  .data-table tbody tr {
    transition: background 0.15s;
  }
  .data-table tbody tr:hover {
    background: var(--color-hover);
  }
  .status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.875rem;
    border-radius: 8px;
    font-weight: 700;
    font-size: 0.875rem;
    letter-spacing: 0.02em;
  }
  .status-success {
    background: #D1FAE5;
    color: #065F46;
  }
  .dark .status-success {
    background: rgba(16, 185, 129, 0.15);
    color: #6EE7B7;
  }
  .status-danger {
    background: #FEE2E2;
    color: #991B1B;
  }
  .dark .status-danger {
    background: rgba(239, 68, 68, 0.15);
    color: #FCA5A5;
  }
  .status-warning {
    background: #FEF3C7;
    color: #92400E;
  }
  .dark .status-warning {
    background: rgba(251, 191, 36, 0.15);
    color: #FCD34D;
  }
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(99, 102, 241, 0.2);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.7);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }
  .loading-overlay.active { display: flex; }
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.75);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
    padding: 1.5rem;
  }
  .modal-overlay.active { display: flex; }
  .modal-content {
    background: var(--color-surface);
    border-radius: 16px;
    padding: 2rem;
    max-width: 500px;
    width: 100%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    border: 1.5px solid var(--color-border);
  }
  .animate-in {
    animation: fadeInUp 0.5s ease-out forwards;
    opacity: 0;
  }
  .delay-1 { animation-delay: 0.1s; }
  .delay-2 { animation-delay: 0.2s; }
  .delay-3 { animation-delay: 0.3s; }
  .delay-4 { animation-delay: 0.4s; }
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  @media (max-width: 768px) {
    header { padding: 1rem; }
    h1 { font-size: 1.375rem; }
    main { padding: 1.25rem 1rem; }
    .panel { padding: 1.25rem; }
    .header-actions { gap: 0.5rem; }
    .icon-btn { width: 38px; height: 38px; }
  }
 </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div class="app-wrapper">
   <header>
    <div class="header-content">
     <h1 id="dashboard-title">Analytics Dashboard</h1>
     <div class="header-actions"><button class="icon-btn" id="theme-toggle" title="Toggle theme">
       <svg id="sun-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
       </svg>
       <svg id="moon-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
       </svg></button> <button class="btn-primary" id="upload-btn" type="button">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
       </svg> Upload </button>
     </div>
    </div>
   </header>
   <main><!-- Filter Panel -->
    <div class="panel mb-8 animate-in delay-1">
     <div class="flex items-center justify-between mb-6">
      <h3 class="text-lg font-semibold" style="color: var(--color-text);">Filters &amp; Time Range</h3>
      <div class="toggle-group"><button class="toggle-btn active" id="agg-daily">Daily</button> <button class="toggle-btn" id="agg-weekly">Weekly</button> <button class="toggle-btn" id="agg-monthly">Monthly</button>
      </div>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><!-- Start Time -->
      <div><label class="block text-sm font-bold mb-3" style="color: var(--color-text);">Start Time</label>
       <div class="grid grid-cols-2 gap-3">
        <div><label for="start-date" class="block text-xs font-semibold mb-2" style="color: var(--color-muted);">Date</label> <input type="date" id="start-date" class="input-field w-full">
        </div>
        <div><label for="start-hour" class="block text-xs font-semibold mb-2" style="color: var(--color-muted);">Hour (24h)</label> <select id="start-hour" class="input-field w-full font-mono"> <option value="00" selected>00:00</option><option value="01">01:00</option><option value="02">02:00</option><option value="03">03:00</option> <option value="04">04:00</option><option value="05">05:00</option><option value="06">06:00</option><option value="07">07:00</option> <option value="08">08:00</option><option value="09">09:00</option><option value="10">10:00</option><option value="11">11:00</option> <option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option> <option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option> <option value="20">20:00</option><option value="21">21:00</option><option value="22">22:00</option><option value="23">23:00</option> </select>
        </div>
       </div>
      </div><!-- End Time -->
      <div><label class="block text-sm font-bold mb-3" style="color: var(--color-text);">End Time</label>
       <div class="grid grid-cols-2 gap-3">
        <div><label for="end-date" class="block text-xs font-semibold mb-2" style="color: var(--color-muted);">Date</label> <input type="date" id="end-date" class="input-field w-full">
        </div>
        <div><label for="end-hour" class="block text-xs font-semibold mb-2" style="color: var(--color-muted);">Hour (24h)</label> <select id="end-hour" class="input-field w-full font-mono"> <option value="00">00:00</option><option value="01">01:00</option><option value="02">02:00</option><option value="03">03:00</option> <option value="04">04:00</option><option value="05">05:00</option><option value="06">06:00</option><option value="07">07:00</option> <option value="08">08:00</option><option value="09">09:00</option><option value="10">10:00</option><option value="11">11:00</option> <option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option> <option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option> <option value="20">20:00</option><option value="21">21:00</option><option value="22">22:00</option><option value="23" selected>23:00</option> </select>
        </div>
       </div>
      </div>
     </div>
     <div class="mt-6 flex items-center justify-between gap-3 flex-wrap">
      <div class="text-sm" style="color: var(--color-muted);"><span class="font-bold" style="color: var(--color-text);">Cache coverage:</span> <span id="cache-coverage" class="font-semibold">unknown</span>
      </div>
      <div class="flex gap-3">
        <button class="btn-ghost" id="clear-cache" type="button" style="border-color: rgba(239,68,68,.35); color: #ef4444;"> Clear Cache </button>
        <button class="btn-ghost" id="manual-scan" type="button"> Manual Scan </button>
        <button class="btn-primary" id="apply-filter" type="button">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg> Apply Filter </button>
      </div>
     </div>
    </div>
    <h2 id="summary-title" class="text-2xl font-bold mb-6 animate-in delay-2" style="color: var(--color-text);">Summary Overview</h2><!-- Summary Matrix -->
    <div class="panel mb-8 animate-in delay-2">
     <div class="flex items-center justify-between mb-5">
      <h3 class="text-lg font-semibold" style="color: var(--color-text);">Tray Summary (Unique SN)</h3><span class="text-sm font-semibold" style="color: var(--color-muted);">Rows: Tested / Pass / Fail • Cols: BP / Fresh / Total</span>
     </div>
     <div class="overflow-x-auto">
      <table class="data-table" id="summary-matrix">
       <thead>
        <tr>
         <th>Metric</th>
         <th>BP</th>
         <th>Fresh</th>
         <th>Total</th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td class="font-bold">Tested</td>
         <td class="font-mono" id="m-tested-bp">-</td>
         <td class="font-mono" id="m-tested-fresh">-</td>
         <td class="font-mono" id="m-tested-total">-</td>
        </tr>
        <tr>
         <td class="font-bold">Pass</td>
         <td class="font-mono" id="m-pass-bp">-</td>
         <td class="font-mono" id="m-pass-fresh">-</td>
         <td class="font-mono" id="m-pass-total">-</td>
        </tr>
        <tr>
         <td class="font-bold">Fail</td>
         <td class="font-mono" id="m-fail-bp">-</td>
         <td class="font-mono" id="m-fail-fresh">-</td>
         <td class="font-mono" id="m-fail-total">-</td>
        </tr>
       </tbody>
      </table>
     </div>
    </div><!-- SKU Table -->
    <div class="panel mb-8 animate-in delay-3">
     <div class="flex items-center justify-between mb-5">
      <h3 class="text-lg font-semibold" style="color: var(--color-text);">SKU (Part Number) Summary</h3><span class="text-sm font-semibold" style="color: var(--color-muted);">Each SN is assigned to its latest Part Number in range</span>
     </div>
     <div class="overflow-x-auto">
      <table class="data-table" id="sku-table">
       <thead>
        <tr>
         <th>SKU</th>
         <th>Tested</th>
         <th>Pass</th>
         <th>Fail</th>
        </tr>
       </thead>
       <tbody id="sku-tbody">
        <tr>
         <td colspan="4" style="color: var(--color-muted);">No data yet. Apply a filter to load.</td>
        </tr>
       </tbody>
      </table>
     </div>
    </div><!-- Breakdown Table -->
    <div class="panel animate-in delay-4">
     <div class="flex items-center justify-between mb-5">
      <h3 class="text-lg font-semibold" style="color: var(--color-text);">Time Breakdown</h3><span class="text-sm font-bold" style="color: var(--color-muted);" id="breakdown-label">Daily</span>
     </div>
     <div class="overflow-x-auto">
      <table class="data-table" id="breakdown-table">
       <thead>
        <tr>
         <th>Period</th>
         <th>Tested</th>
         <th>Passed</th>
         <th>Bonepile</th>
         <th>Fresh</th>
         <th>Pass Rate</th>
        </tr>
       </thead>
       <tbody id="breakdown-tbody">
        <tr>
         <td colspan="6" style="color: var(--color-muted);">No data yet. Apply a filter to load.</td>
        </tr>
       </tbody>
      </table>
     </div>
    </div>
   </main>
  </div><!-- Loading overlay -->
  <div class="loading-overlay" id="loading-overlay">
   <div class="panel" style="background: rgba(15, 23, 42, 0.95); border-color: rgba(99, 102, 241, 0.3); color: white; max-width: 520px;">
    <div class="flex items-center gap-4">
     <div class="spinner"></div>
     <div>
      <div class="text-lg font-bold">
       Scanning…
      </div>
      <div class="text-sm mt-1" style="color: rgba(255,255,255,0.8);" id="loading-text">
       Preparing scan job
      </div>
     </div>
    </div>
   </div>
  </div><!-- Upload Modal -->
  <div class="modal-overlay" id="upload-modal">
   <div class="modal-content">
    <div class="flex items-center justify-between mb-6">
     <h3 class="text-xl font-bold" style="color: var(--color-text);">Upload File</h3><button class="w-9 h-9 rounded-lg flex items-center justify-center transition-colors" style="background: var(--color-bg);" id="close-modal">
      <svg class="w-5 h-5" style="color: var(--color-muted);" fill="none" stroke="currentColor" viewbox="0 0 24 24">
       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg></button>
    </div>
    <div class="border-2 border-dashed rounded-xl p-8 text-center transition-colors" style="border-color: var(--color-border); background: var(--color-bg);" id="drop-zone">
     <svg class="w-12 h-12 mx-auto mb-4" style="color: var(--color-primary);" fill="none" stroke="currentColor" viewbox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
     </svg>
     <p class="font-semibold mb-2" style="color: var(--color-text);">Drag &amp; drop your file here</p>
     <p class="text-sm mb-4" style="color: var(--color-muted);">or click to browse</p><input type="file" id="file-input" class="hidden" accept=".csv,.xlsx,.json"> <button class="btn-primary" id="browse-btn" type="button">Browse Files</button>
    </div>
    <p class="text-xs mt-4 text-center" style="color: var(--color-muted);">Supported formats: CSV, XLSX, JSON (Max 10MB)</p>
   </div>
  </div>
  <script>
   const defaultConfig = {
     dashboard_title: 'Analytics Dashboard',
     summary_title: 'Summary Overview',
     primary_color: '#6366F1',
     surface_color: '#FFFFFF',
     text_color: '#1E293B',
     background_color: '#F1F5F9',
     accent_color: '#10B981'
   };
   let config = { ...defaultConfig };

   // Theme
   let isDarkMode = false;
   function toggleTheme() {
     isDarkMode = !isDarkMode;
     document.documentElement.classList.toggle('dark', isDarkMode);
     document.getElementById('sun-icon').classList.toggle('hidden', !isDarkMode);
     document.getElementById('moon-icon').classList.toggle('hidden', isDarkMode);
   }

   // Modal handling
   function openModal() { document.getElementById('upload-modal').classList.add('active'); }
   function closeModal() { document.getElementById('upload-modal').classList.remove('active'); }

   // Loading overlay
   function setLoading(active, text) {
     const el = document.getElementById('loading-overlay');
     const t = document.getElementById('loading-text');
     if (t && text) t.textContent = text;
     el.classList.toggle('active', !!active);
   }

   // Aggregation toggle
   let aggregation = 'daily';
   function setAgg(a) {
     aggregation = a;
     document.getElementById('agg-daily').classList.toggle('active', a === 'daily');
     document.getElementById('agg-weekly').classList.toggle('active', a === 'weekly');
     document.getElementById('agg-monthly').classList.toggle('active', a === 'monthly');
     document.getElementById('breakdown-label').textContent = a.charAt(0).toUpperCase() + a.slice(1);
   }

   // Helpers
   function fmtPct(x) {
     if (x === null || x === undefined) return '-';
     return Math.round(x * 100) + '%';
   }

   function setText(id, value) {
     const el = document.getElementById(id);
     if (el) el.textContent = (value === null || value === undefined) ? '-' : value;
   }

   async function refreshCacheCoverage() {
     try {
       const res = await fetch('/api/status');
       const data = await res.json();
       const c = data.cache || {};
       if (!c.min_ca_ms || !c.max_ca_ms) {
         document.getElementById('cache-coverage').textContent = 'no cache yet';
         return;
       }
       const min = new Date(c.min_ca_ms).toLocaleString();
       const max = new Date(c.max_ca_ms).toLocaleString();
       document.getElementById('cache-coverage').textContent = `${min} → ${max}`;
     } catch (e) {
       document.getElementById('cache-coverage').textContent = 'unknown';
     }
   }

   function getRangePayload() {
     const startDate = document.getElementById('start-date').value;
     const endDate = document.getElementById('end-date').value;
     const startHour = document.getElementById('start-hour').value;
     const endHour = document.getElementById('end-hour').value;
     return {
       start_datetime: `${startDate} ${startHour}:00`,
       // Treat end hour as inclusive (cover the full hour).
       // Example: endHour=23 => include up to 23:59.
       end_datetime: `${endDate} ${endHour}:59`,
       aggregation
     };
   }

   function renderSummary(summary) {
     setText('m-tested-bp', summary?.bp?.tested);
     setText('m-tested-fresh', summary?.fresh?.tested);
     setText('m-tested-total', summary?.total?.tested);
     setText('m-pass-bp', summary?.bp?.pass);
     setText('m-pass-fresh', summary?.fresh?.pass);
     setText('m-pass-total', summary?.total?.pass);
     setText('m-fail-bp', summary?.bp?.fail);
     setText('m-fail-fresh', summary?.fresh?.fail);
     setText('m-fail-total', summary?.total?.fail);
   }

   function renderSkuRows(rows) {
     const tbody = document.getElementById('sku-tbody');
     if (!tbody) return;
     if (!rows || !rows.length) {
       tbody.innerHTML = `<tr><td colspan="4" style="color: var(--color-muted);">No data</td></tr>`;
       return;
     }
     tbody.innerHTML = rows.map(r => `
       <tr>
         <td class="font-mono font-semibold">${(r.sku || 'Unknown')}</td>
         <td class="font-mono font-semibold">${r.tested ?? 0}</td>
         <td class="font-mono"><span class="status-badge status-success">${r.pass ?? 0}</span></td>
         <td class="font-mono"><span class="status-badge status-danger">${r.fail ?? 0}</span></td>
       </tr>
     `).join('');
   }

   function renderBreakdown(rows) {
     const tbody = document.getElementById('breakdown-tbody');
     if (!tbody) return;
     if (!rows || !rows.length) {
       tbody.innerHTML = `<tr><td colspan="6" style="color: var(--color-muted);">No data</td></tr>`;
       return;
     }
     tbody.innerHTML = rows.map(r => `
       <tr>
         <td class="font-mono font-semibold">${r.period}</td>
         <td class="font-mono font-semibold">${r.tested ?? 0}</td>
         <td class="font-mono"><span class="status-badge status-success">${r.passed ?? 0}</span></td>
         <td class="font-mono font-semibold">${r.bonepile ?? 0}</td>
         <td class="font-mono font-semibold">${r.fresh ?? 0}</td>
         <td><span class="status-badge ${((r.pass_rate || 0) >= 0.5) ? 'status-success' : 'status-warning'}">${fmtPct(r.pass_rate || 0)}</span></td>
       </tr>
     `).join('');
   }

   async function pollJob(jobId) {
     for (let i = 0; i < 600; i++) {
       const res = await fetch(`/api/job/${encodeURIComponent(jobId)}`);
       const data = await res.json();
       if (data.status === 'done') return data;
       if (data.status === 'error') throw new Error(data.error || 'scan error');
       setLoading(true, data.message || 'Scanning...');
       await new Promise(r => setTimeout(r, 1000));
     }
     throw new Error('scan timeout');
   }

   async function runQuery({forceScan = false} = {}) {
     const payload = getRangePayload();
     if (forceScan) {
       setLoading(true, 'Starting manual scan...');
       const res = await fetch('/api/scan', {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ start_datetime: payload.start_datetime, end_datetime: payload.end_datetime })
       });
       const scan = await res.json();
       if (scan.error) throw new Error(scan.error);
       await pollJob(scan.job_id);
     }

     setLoading(true, 'Loading data...');
     const res = await fetch('/api/query', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify(payload)
     });
     const data = await res.json();
     if (data.error) throw new Error(data.error);

     if (data.needs_scan) {
       await pollJob(data.job_id);
       return runQuery({forceScan: false});
     }

     renderSummary(data.summary);
     renderSkuRows(data.sku_rows);
     renderBreakdown(data.breakdown_rows);
     await refreshCacheCoverage();
     setLoading(false);
   }

   // Event listeners
   document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
   document.getElementById('upload-btn').addEventListener('click', openModal);
   document.getElementById('close-modal').addEventListener('click', closeModal);
   document.getElementById('upload-modal').addEventListener('click', (e) => { if (e.target.id === 'upload-modal') closeModal(); });
   document.getElementById('browse-btn').addEventListener('click', () => { document.getElementById('file-input').click(); });

   document.getElementById('apply-filter').addEventListener('click', () => {
     runQuery().catch(err => {
       console.error(err);
       setLoading(false);
       alert('Error: ' + err.message);
     });
   });

   document.getElementById('manual-scan').addEventListener('click', () => {
     runQuery({forceScan: true}).catch(err => {
       console.error(err);
       setLoading(false);
       alert('Error: ' + err.message);
     });
   });

   document.getElementById('clear-cache').addEventListener('click', async () => {
     try {
       if (!confirm('Clear cache will delete local analytics cache and rescan from scratch. Continue?')) return;
       setLoading(true, 'Clearing cache...');
       const res = await fetch('/api/clear-cache', { method: 'POST' });
       const data = await res.json();
       if (data.error) throw new Error(data.error);
       await refreshCacheCoverage();
       setLoading(false);
       alert('Cache cleared. Now run Manual Scan or Apply Filter to rebuild.');
     } catch (err) {
       console.error(err);
       setLoading(false);
       alert('Error: ' + (err?.message || err));
     }
   });

   document.getElementById('agg-daily').addEventListener('click', () => setAgg('daily'));
   document.getElementById('agg-weekly').addEventListener('click', () => setAgg('weekly'));
   document.getElementById('agg-monthly').addEventListener('click', () => setAgg('monthly'));

   // Set default dates (last 7 days)
   const today = new Date();
   const lastWeek = new Date(today);
   lastWeek.setDate(lastWeek.getDate() - 7);
   document.getElementById('start-date').value = lastWeek.toISOString().split('T')[0];
   document.getElementById('end-date').value = today.toISOString().split('T')[0];
   document.getElementById('start-hour').value = '00';
   document.getElementById('end-hour').value = '23';

   // Element SDK integration
   async function onConfigChange(newConfig) {
     config = { ...config, ...newConfig };
     const titleEl = document.getElementById('dashboard-title');
     if (titleEl) titleEl.textContent = config.dashboard_title || defaultConfig.dashboard_title;
     const summaryEl = document.getElementById('summary-title');
     if (summaryEl) summaryEl.textContent = config.summary_title || defaultConfig.summary_title;
   }

   function mapToCapabilities(cfg) {
     return {
       recolorables: [
         { get: () => cfg.background_color || defaultConfig.background_color, set: (value) => { cfg.background_color = value; window.elementSdk.setConfig({ background_color: value }); } },
         { get: () => cfg.surface_color || defaultConfig.surface_color, set: (value) => { cfg.surface_color = value; window.elementSdk.setConfig({ surface_color: value }); } },
         { get: () => cfg.text_color || defaultConfig.text_color, set: (value) => { cfg.text_color = value; window.elementSdk.setConfig({ text_color: value }); } },
         { get: () => cfg.primary_color || defaultConfig.primary_color, set: (value) => { cfg.primary_color = value; window.elementSdk.setConfig({ primary_color: value }); } },
         { get: () => cfg.accent_color || defaultConfig.accent_color, set: (value) => { cfg.accent_color = value; window.elementSdk.setConfig({ accent_color: value }); } }
       ],
       borderables: [],
       fontEditable: undefined,
       fontSizeable: undefined
     };
   }
   function mapToEditPanelValues(cfg) {
     return new Map([
       ['dashboard_title', cfg.dashboard_title || defaultConfig.dashboard_title],
       ['summary_title', cfg.summary_title || defaultConfig.summary_title]
     ]);
   }
   if (window.elementSdk) {
     window.elementSdk.init({ defaultConfig, onConfigChange, mapToCapabilities, mapToEditPanelValues });
   }

   // Init
   refreshCacheCoverage();
 </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c67749907a36893',t:'MTc2OTg0NDEyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>